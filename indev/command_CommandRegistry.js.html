<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>command/CommandRegistry.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="/index.html">Stable</a><a href="/indev/index.html">Indev</a></h2><h3>Pages</h3><ul><li><a href="tutorial-LocalizationGuide.html">Localization Guide</a></li><li><a href="tutorial-LocalizationHelptext.html">Localizing Command helptext</a></li><li><a href="tutorial-LocalizationStrings.html">Localization string list</a></li><li><a href="tutorial-StartingInV3.html">Starting a bot in 3.0.0</a></li></ul><h3>Classes</h3><ul><li><a href="Client.html">Client</a></li><li><a href="ClientStorage.html">ClientStorage</a></li><li><a href="Command.html">Command</a></li><li><a href="CommandRegistry.html">CommandRegistry</a></li><li><a href="Database.html">Database</a></li><li><a href="GuildSettings.html">GuildSettings</a></li><li><a href="GuildStorage.html">GuildStorage</a></li><li><a href="KeyedStorage.html">KeyedStorage</a></li><li><a href="Logger.html">Logger</a></li><li><a href="Plugin.html">Plugin</a></li><li><a href="PluginLoader.html">PluginLoader</a></li><li><a href="RateLimit.html">RateLimit</a></li><li><a href="RateLimiter.html">RateLimiter</a></li><li><a href="StorageProvider.html">StorageProvider</a></li></ul><h3>Interfaces</h3><ul><li><a href="IPlugin.html">IPlugin</a></li><li><a href="IStorageProvider.html">IStorageProvider</a></li></ul><h3>Mixins</h3><ul><li><a href="Guild.html">Guild</a></li><li><a href="Loggable.html">Loggable</a></li><li><a href="Message.html">Message</a></li></ul><h3>Modules</h3><ul><li><a href="module-CommandDecorators.html">CommandDecorators</a></li><li><a href="module-Lang.html">Lang</a></li><li><a href="module-ListenerUtil.html">ListenerUtil</a></li><li><a href="module-Middleware.html">Middleware</a></li><li><a href="module-Providers.html">Providers</a></li><li><a href="module-Time.html">Time</a></li><li><a href="module-Util.html">Util</a></li></ul><h3>Decorators</h3><ul><li><a href="global.html#deprecated">deprecated</a></li><li><a href="global.html#logger">logger</a></li></ul><h3>TypeDefs</h3><ul><li><a href="global.html#ArgOpts">ArgOpts</a></li><li><a href="global.html#CommandInfo">CommandInfo</a></li><li><a href="global.html#DefaultGuildSettings">DefaultGuildSettings</a></li><li><a href="global.html#Difference">Difference</a></li><li><a href="global.html#ExpectArgType">ExpectArgType</a></li><li><a href="global.html#LocalizedCommandInfo">LocalizedCommandInfo</a></li><li><a href="global.html#LogData">LogData</a></li><li><a href="global.html#LogLevel">LogLevel</a></li><li><a href="global.html#MiddlewareFunction">MiddlewareFunction</a></li><li><a href="global.html#PluginConstructor">PluginConstructor</a></li><li><a href="global.html#ResolveArgType">ResolveArgType</a></li><li><a href="global.html#ResourceLoader">ResourceLoader</a></li><li><a href="global.html#StorageProviderConstructor">StorageProviderConstructor</a></li><li><a href="global.html#TemplateData">TemplateData</a></li><li><a href="global.html#Transport">Transport</a></li><li><a href="global.html#TransportFunction">TransportFunction</a></li><li><a href="global.html#Tuple">Tuple</a></li><li><a href="global.html#YAMDBFOptions">YAMDBFOptions</a></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-ClientOptions.html">ClientOptions</a></li><li><a href="external-Collection.html">Collection</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-MessageOptions.html">MessageOptions</a></li><li><a href="external-PermissionResolvable.html">PermissionResolvable</a></li><li><a href="external-Role.html">Role</a></li><li><a href="external-User.html">User</a></li></ul>
</nav>

<div id="main">
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Collection, TextChannel, PermissionResolvable } from 'discord.js';
import { Command } from '../command/Command';
import { Client } from '../client/Client';
import { Message } from '../types/Message';
import { Logger } from '../util/logger/Logger';
import { BaseCommandName } from '../types/BaseCommandName';

/**
 * @classdesc Stores loaded Commands in a Collection keyed by each Command's `name` property
 * @class CommandRegistry
 * @extends {external:Collection}
 */
export class CommandRegistry&lt;T extends Client, K extends string, V extends Command&lt;T>> extends Collection&lt;K, V>
{
	public constructor() { super(); }

	/**
	 * Complete registration of a command and add to the parent
	 * collection, erroring on duplicate names and aliases.
	 * This is an internal method and should not be used. Use
	 * `registerExternal()` instead
	 * @private
	 */
	public _registerInternal(client: T, command: V, reload: boolean = false, external: boolean = false): void
	{
		if (reload &amp;&amp; external) return;
		if (super.has(&lt;K> command.name) &amp;&amp; !reload
			&amp;&amp; !(command.overloads &amp;&amp; super.has(&lt;K> command.overloads)
				&amp;&amp; command.overloads !== super.get(&lt;K> command.overloads).name))
				if (!external) throw new Error(`A command with the name "${command.name}" already exists`);
				else throw new Error(`External command is conflicting with command "${command.name}"`);

		command._register(client);
		super.set(&lt;K> command.name, command);

		for (const cmd of this.values())
		{
			for (const alias of cmd.aliases)
			{
				let duplicates: Collection&lt;K, V> = this.filter(c => c.aliases.includes(alias) &amp;&amp; c !== cmd);
				if (duplicates.size > 0)
				{
					const duplicate: string = duplicates.first().name;
					const name: string = cmd.name;
					if (!external) throw new Error(
						`Commands may not share aliases: ${name}, ${duplicate} (shared alias: "${alias}")`);
					else throw new Error(
						`External command has conflicting alias with "${name}" (shared alias: "${alias}")`);
				}
			}
		}
	}

	/**
	 * Register an external command and add it to the `&lt;Client>.commands`
	 * [collection]{@link external:Collection}, erroring on duplicate
	 * names and aliases. External commands will be preserved when the
	 * `reload` command is called.
	 *
	 * >**Note:** This is intended for Plugins to use to register external
	 * commands with the Client instance. Under normal circumstances
	 * commands should be added by placing them in the directory passed
	 * to the `commandsDir` YAMDBF Client option
	 * @param {Client} client YAMDBF Client instance
	 * @param {Command} command The Command instance to be registered
	 * @returns {void}
	 */
	public registerExternal(client: T, command: Command&lt;any>): void
	{
		if (command.overloads)
		{
			if (client.disableBase.includes(&lt;BaseCommandName> command.overloads)) return;
			let overload: boolean = this.has(&lt;K> command.overloads);
			this.delete(&lt;K> command.overloads);
			this._registerInternal(client, &lt;V> command, false, true);
			Logger.instance().info('CommandRegistry',
				`External command '${command.name}' registered${
					overload ? `, overloading base command '${command.overloads}'.` : '.'}`);
		}
		else
		{
			this._registerInternal(client, &lt;V> command, false, true);
			Logger.instance().info('CommandRegistry', `External command '${command.name}' registered.`);
		}
		command.external = true;
	}

	/**
	 * Contains all [Command groups]{@link Command#group}
	 * @type {string[]}
	 */
	public get groups(): string[]
	{
		return this.map(a => a.group).filter((a, i, self) => self.indexOf(a) === i);
	}

	/**
	 * Finds a command by [name]{@link Command#name} or [alias]{@link Command#aliases}
	 * @param {string} text The name or alias of the Command
	 * @returns {Command}
	 */
	public findByNameOrAlias(text: string): V
	{
		text = text.toLowerCase();
		return this.find(c => c.name.toLowerCase() === text
			|| !!c.aliases.find(a => a.toLowerCase() === text));
	}

	/**
	 * Returns a Promise resolving with a collection of all commands usable
	 * by the caller in the guild text channel the provided message is in.
	 * Needs to be async due to having to access guild settings to check
	 * for disabled groups
	 * @param {Client} client YAMDBF Client instance
	 * @param {external:Message} message Discord.js Message object
	 * @returns {Promise&lt;external:Collection&lt;string, Command>>}
	 */
	public async filterGuildUsable(client: T, message: Message): Promise&lt;Collection&lt;K, V>>
	{
		let filtered: Collection&lt;K, V> = new Collection&lt;K, V>();
		const currentPermissions: (a: PermissionResolvable) => boolean = a =>
			(&lt;TextChannel> message.channel).permissionsFor(message.author).has(a);

		const byPermissions: (c: V) => boolean = c =>
			c.callerPermissions.length > 0 ? c.callerPermissions.filter(currentPermissions).length > 0 : true;

		const byRoles: (c: V) => boolean = c =>
			!(c.roles.length > 0 &amp;&amp; message.member.roles.filter(role => c.roles.includes(role.name)).size === 0);

		const byOwnerOnly: (c: V) => boolean = c =>
			(client.isOwner(message.author) &amp;&amp; c.ownerOnly) || !c.ownerOnly;

		const disabledGroups: string[] = await message.guild.storage.settings.get('disabledGroups') || [];
		for (const [name, command] of this.filter(byPermissions).filter(byRoles).filter(byOwnerOnly).entries())
			if (!disabledGroups.includes(command.group)) filtered.set(name, command);

		return filtered;
	}

	/**
	 * Returns all commands usable by the caller within the DM channel the provided
	 * message is in
	 * @param {Client} client YAMDBF Client instance
	 * @param {external:Message} message - Discord.js Message object
	 * @returns {external:Collection&lt;string, Command>}
	 */
	public filterDMUsable(client: T, message: Message): Collection&lt;K, V>
	{
		return this.filter(c => !c.guildOnly &amp;&amp;
			((client.isOwner(message.author) &amp;&amp; c.ownerOnly) || !c.ownerOnly));
	}

	/**
	 * Returns all commands that can have their help looked up by the caller
	 * in the DM channel the message is in
	 * @param {Client} client YAMDBF Client instance
	 * @param {external:Message} message Discord.js Message object
	 * @returns {external:Collection&lt;string, Command>}
	 */
	public filterDMHelp(client: T, message: Message): Collection&lt;K, V>
	{
		return this.filter(c => (client.isOwner(message.author) &amp;&amp; c.ownerOnly) || !c.ownerOnly);
	}
}
</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
	<div align="right">
    	<a href="https://github.com/jsdoc3/jsdoc">JSDoc3.5.0-dev</a> | Minami
	</div>
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
