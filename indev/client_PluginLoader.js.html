<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>client/PluginLoader.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="/index.html">Stable</a><a href="/indev/index.html">Indev</a></h2><h3>Pages</h3><ul><li><a href="tutorial-LocalizationGuide.html">Localization Guide</a></li><li><a href="tutorial-LocalizationHelptext.html">Localizing Command helptext</a></li><li><a href="tutorial-LocalizationStrings.html">Localization string list</a></li><li><a href="tutorial-PluginList.html">Plugin list</a></li><li><a href="tutorial-StartingInV3.html">Starting a bot in 3.0.0</a></li></ul><h3>Classes</h3><ul><li><a href="Client.html">Client</a></li><li><a href="ClientStorage.html">ClientStorage</a></li><li><a href="Command.html">Command</a></li><li><a href="CommandRegistry.html">CommandRegistry</a></li><li><a href="Database.html">Database</a></li><li><a href="GuildSettings.html">GuildSettings</a></li><li><a href="GuildStorage.html">GuildStorage</a></li><li><a href="KeyedStorage.html">KeyedStorage</a></li><li><a href="Logger.html">Logger</a></li><li><a href="Plugin.html">Plugin</a></li><li><a href="PluginLoader.html">PluginLoader</a></li><li><a href="RateLimit.html">RateLimit</a></li><li><a href="RateLimiter.html">RateLimiter</a></li><li><a href="StorageProvider.html">StorageProvider</a></li></ul><h3>Interfaces</h3><ul><li><a href="IPlugin.html">IPlugin</a></li><li><a href="IStorageProvider.html">IStorageProvider</a></li></ul><h3>Mixins</h3><ul><li><a href="Guild.html">Guild</a></li><li><a href="Loggable.html">Loggable</a></li><li><a href="Message.html">Message</a></li></ul><h3>Modules</h3><ul><li><a href="module-CommandDecorators.html">CommandDecorators</a></li><li><a href="module-Lang.html">Lang</a></li><li><a href="module-ListenerUtil.html">ListenerUtil</a></li><li><a href="module-Middleware.html">Middleware</a></li><li><a href="module-Providers.html">Providers</a></li><li><a href="module-Time.html">Time</a></li><li><a href="module-Util.html">Util</a></li></ul><h3>Decorators</h3><ul><li><a href="global.html#deprecated">deprecated</a></li><li><a href="global.html#logger">logger</a></li></ul><h3>TypeDefs</h3><ul><li><a href="global.html#ArgOpts">ArgOpts</a></li><li><a href="global.html#BaseStrings">BaseStrings</a></li><li><a href="global.html#CommandInfo">CommandInfo</a></li><li><a href="global.html#DefaultGuildSettings">DefaultGuildSettings</a></li><li><a href="global.html#Difference">Difference</a></li><li><a href="global.html#ExpectArgType">ExpectArgType</a></li><li><a href="global.html#LocalizedCommandInfo">LocalizedCommandInfo</a></li><li><a href="global.html#LogData">LogData</a></li><li><a href="global.html#LogLevel">LogLevel</a></li><li><a href="global.html#MiddlewareFunction">MiddlewareFunction</a></li><li><a href="global.html#PluginConstructor">PluginConstructor</a></li><li><a href="global.html#ResolveArgType">ResolveArgType</a></li><li><a href="global.html#ResourceLoader">ResourceLoader</a></li><li><a href="global.html#StorageProviderConstructor">StorageProviderConstructor</a></li><li><a href="global.html#TemplateData">TemplateData</a></li><li><a href="global.html#Transport">Transport</a></li><li><a href="global.html#TransportFunction">TransportFunction</a></li><li><a href="global.html#Tuple">Tuple</a></li><li><a href="global.html#YAMDBFOptions">YAMDBFOptions</a></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-ClientOptions.html">ClientOptions</a></li><li><a href="external-Collection.html">Collection</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-MessageOptions.html">MessageOptions</a></li><li><a href="external-PermissionResolvable.html">PermissionResolvable</a></li><li><a href="external-Role.html">Role</a></li><li><a href="external-User.html">User</a></li></ul>
</nav>

<div id="main">
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Client } from './Client';
import { Plugin } from './Plugin';
import { Logger } from '../util/logger/Logger';
import { PluginConstructor } from '../types/PluginConstructor';

/**
 * Loads plugins and holds loaded plugins in case accessing
 * loaded plugins at runtime is desired
 * @param {Client} client
 * @param {Array&lt;PluginConstructor|string>} plugins
 */
export class PluginLoader
{
	private logger: Logger = Logger.instance();
	private _client: Client;
	private _plugins: (PluginConstructor | string)[];
	public loaded: { [name: string]: any };

	public constructor(client: Client, plugins: (PluginConstructor | string)[])
	{
		this._client = client;
		this._plugins = plugins;

		/**
		 * Object mapping Plugin names to Plugin instances
		 * @type {object}
		 */
		this.loaded = {};
	}

	/**
	 * Loads the plugins passed in the YAMDBF Client options.
	 * Called internally by the YAMDBF Client at startup
	 * @private
	 */
	public async _loadPlugins(): Promise&lt;void>
	{
		const tag: string = 'PluginLoader';
		for (const [index, plugin] of this._plugins.entries())
		{
			let loadedPlugin: Plugin;
			if (typeof plugin === 'string')
			{
				let error: string;
				if (!/^yamdbf-/.test(plugin))
				{
					try { loadedPlugin = new (require(plugin))(this._client); }
					catch (err) { error = `${err}, trying 'yamdbf-${plugin}'...`; }

					try { loadedPlugin = loadedPlugin || new (require(`yamdbf-${plugin}`))(this._client); }
					catch (err) { error = error ? `${error}\n${err}` : err; }
				}
				else
				{
					try { loadedPlugin = new (require(plugin))(this._client); }
					catch (err) { error = err; }
				}

				if (!loadedPlugin) {
					this.logger.warn(tag, `Failed to load plugin '${plugin}':\n\n${error}\n`);
					continue;
				}
			}
			else
			{
				try { loadedPlugin = new plugin(this._client); }
				catch (err)
				{
					this.logger.warn(tag, `Failed to load plugin at plugins[${index}]:\n\n${err}\n`);
					continue;
				}
			}

			if (typeof loadedPlugin.name === 'undefined' || loadedPlugin.name === '')
			{
				this.logger.warn(tag, `Plugin at plugins[${index}] is invalid: Missing name`);
				continue;
			}

			if (typeof loadedPlugin.init === 'undefined')
			{
				this.logger.warn(tag, `Plugin at plugins[${index}] is invalid: Missing init()`);
				continue;
			}

			if (typeof this.loaded[loadedPlugin.name] !== 'undefined')
			{
				this.logger.warn(tag, `Skipping Plugin at plugins[${index}]: Duplicate name '${loadedPlugin.name}'`);
				continue;
			}

			this.logger.info(tag, `Plugin '${loadedPlugin.name}' loaded, initializing...`);
			try
			{
				await loadedPlugin.init();
				this.logger.info(tag, `Plugin '${loadedPlugin.name}' initialized.`);
			}
			catch (err)
			{
				this.logger.warn(tag, `Plugin '${loadedPlugin.name}' errored during initialization:\n\n${err.stack}`,
					'\n\nPlease report this error to the plugin author.\n');
				this.logger.info(tag, `Plugin '${loadedPlugin.name}' initialized with errors.`);
			}
			this.loaded[loadedPlugin.name] = loadedPlugin;
		}
	}
}
</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
	<div align="right">
    	<a href="https://github.com/jsdoc3/jsdoc">JSDoc3.5.0-dev</a> | Minami
	</div>
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
