{"version":3,"sources":["client/PluginLoader.ts"],"names":[],"mappings":"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","file":"PluginLoader.js","sourcesContent":["import { Client } from './Client';\nimport { Plugin } from './Plugin';\nimport { Logger, logger } from '../util/logger/Logger';\nimport { StorageProvider } from '../storage/StorageProvider';\nimport { SharedProviderStorage } from '../storage/SharedProviderStorage';\nimport { PluginConstructor } from '../types/PluginConstructor';\n\n/**\n * Loads plugins and holds loaded plugins in case accessing\n * loaded plugins at runtime is desired\n * @param {Client} client\n * @param {Array<PluginConstructor|string>} plugins\n */\nexport class PluginLoader\n{\n\t@logger('PluginLoader')\n\tprivate readonly _logger: Logger;\n\tprivate readonly _client: Client;\n\tprivate readonly _provider: StorageProvider;\n\tprivate _plugins: (PluginConstructor | string)[];\n\n\tpublic loaded: { [name: string]: any };\n\n\tpublic constructor(client: Client, plugins: (PluginConstructor | string)[])\n\t{\n\t\tthis._client = client;\n\t\tthis._plugins = plugins;\n\t\tthis._provider = new this._client.provider('plugin_storage');\n\n\t\t/**\n\t\t * Object mapping Plugin names to Plugin instances\n\t\t * @type {object}\n\t\t */\n\t\tthis.loaded = {};\n\t}\n\n\t/**\n\t * Loads the plugins passed in the YAMDBF Client options.\n\t * Called internally by the YAMDBF Client at startup\n\t * @private\n\t */\n\tpublic async _loadPlugins(): Promise<void>\n\t{\n\t\tawait this._provider.init();\n\t\tthis._logger.debug('Plugin storage provider initialized.');\n\n\t\tfor (const [index, plugin] of this._plugins.entries())\n\t\t{\n\t\t\tlet loadedPlugin: Plugin;\n\t\t\tif (typeof plugin === 'string')\n\t\t\t{\n\t\t\t\tlet error: string;\n\t\t\t\tif (!/^yamdbf-/.test(plugin))\n\t\t\t\t{\n\t\t\t\t\ttry { loadedPlugin = new (require(plugin))(this._client); }\n\t\t\t\t\tcatch (err) { error = `${err}, trying 'yamdbf-${plugin}'...`; }\n\n\t\t\t\t\ttry { loadedPlugin = loadedPlugin || new (require(`yamdbf-${plugin}`))(this._client); }\n\t\t\t\t\tcatch (err) { error = error ? `${error}\\n${err}` : err; }\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\ttry { loadedPlugin = new (require(plugin))(this._client); }\n\t\t\t\t\tcatch (err) { error = err; }\n\t\t\t\t}\n\n\t\t\t\tif (!loadedPlugin) {\n\t\t\t\t\tthis._logger.warn(`Failed to load plugin '${plugin}':\\n\\n${error}\\n`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\ttry { loadedPlugin = new plugin(this._client); }\n\t\t\t\tcatch (err)\n\t\t\t\t{\n\t\t\t\t\tthis._logger.warn(`Failed to load plugin at plugins[${index}]:\\n\\n${err}\\n`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof loadedPlugin.name === 'undefined' || loadedPlugin.name === '')\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Plugin at plugins[${index}] is invalid: Missing name`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (typeof loadedPlugin.init === 'undefined')\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Plugin at plugins[${index}] is invalid: Missing init()`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (typeof this.loaded[loadedPlugin.name] !== 'undefined')\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Skipping Plugin at plugins[${index}]: Duplicate name '${loadedPlugin.name}'`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tlet pluginStorage: SharedProviderStorage;\n\t\t\ttry { pluginStorage = new SharedProviderStorage(this._provider, loadedPlugin.name); }\n\t\t\tcatch { this._logger.warn(`Failed to create storage for Plugin '${loadedPlugin.name}'`); }\n\n\t\t\ttry { await pluginStorage.init(); }\n\t\t\tcatch { this._logger.warn(`Failed to initialize storage for Plugin '${loadedPlugin.name}'`); }\n\n\t\t\tthis._logger.info(`Plugin '${loadedPlugin.name}' loaded, initializing...`);\n\t\t\ttry\n\t\t\t{\n\t\t\t\tawait loadedPlugin.init(pluginStorage);\n\t\t\t\tthis._logger.info(`Plugin '${loadedPlugin.name}' initialized.`);\n\t\t\t}\n\t\t\tcatch (err)\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Plugin '${loadedPlugin.name}' errored during initialization:\\n\\n${err.stack}`,\n\t\t\t\t\t'\\n\\nPlease report this error to the plugin author.\\n');\n\t\t\t\tthis._logger.info(`Plugin '${loadedPlugin.name}' initialized with errors.`);\n\t\t\t}\n\t\t\tthis.loaded[loadedPlugin.name] = loadedPlugin;\n\t\t}\n\t}\n}\n"],"sourceRoot":"../../src"}