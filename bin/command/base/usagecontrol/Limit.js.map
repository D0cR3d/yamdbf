{"version":3,"sources":["command/base/usagecontrol/Limit.ts"],"names":[],"mappings":"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","file":"Limit.js","sourcesContent":["import { GuildStorage } from '../../../storage/GuildStorage';\r\nimport { ResourceLoader } from '../../../types/ResourceLoader';\r\nimport { BaseStrings as s } from '../../../localization/BaseStrings';\r\nimport { Message } from '../../../types/Message';\r\nimport { Command } from '../../Command';\r\nimport { Middleware } from '../../middleware/Middleware';\r\nimport { Role } from 'discord.js';\r\nimport * as CommandDecorators from '../../CommandDecorators';\r\nimport { Resolver } from '../../resolvers/Resolver';\r\nconst { using, localizable } = CommandDecorators;\r\nconst { expect, resolve } = Middleware;\r\n\r\nexport default class extends Command\r\n{\r\n\tpublic constructor()\r\n\t{\r\n\t\tsuper({\r\n\t\t\tname: 'limit',\r\n\t\t\tdesc: 'Limit commands to certain roles',\r\n\t\t\tusage: `<prefix>limit <command> <roles, ...> | <prefix>limit <'clear'> <command>`,\r\n\t\t\tinfo: `Multiple roles can be passed to the command as a comma-separated list.\r\n\r\nIf a role is unable to be found and you know it exists, it could be that there are multiple roles containing the given role name search text. Consider refining your search, or using an @mention for the role you want to use.\r\n\r\nLimiting a command will add the given roles to set of roles the command is limited to.\r\n\r\nUse '<prefix>limit clear <command>' to clear all of the roles a command is limited to.\r\n\r\nRemoving individual roles is not possible to keep the command simple to use.`,\r\n\t\t\tcallerPermissions: ['ADMINISTRATOR']\r\n\t\t});\r\n\t}\r\n\r\n\t@using(function(message, args)\r\n\t{\r\n\t\tif (args[0] === 'clear')\r\n\t\t\treturn resolve(`clear: String, command: Command`)\r\n\t\t\t\t.call(this, message, args);\r\n\t\telse\r\n\t\t\treturn resolve(`command: Command, ...roles: String`)\r\n\t\t\t\t.call(this, message, args);\r\n\t})\r\n\t@using(function(message, args)\r\n\t{\r\n\t\tif (args[0] === 'clear')\r\n\t\t\treturn expect(`clear: String, command: Command`)\r\n\t\t\t\t.call(this, message, args);\r\n\t\telse\r\n\t\t\treturn expect(`command: Command, ...roles: String`)\r\n\t\t\t\t.call(this, message, args);\r\n\t})\r\n\t@localizable\r\n\tpublic async action(message: Message, [res, clearOrCommand, rolesOrCommand]: [ResourceLoader, Command | string, Command | string]): Promise<any>\r\n\t{\r\n\t\tif (clearOrCommand === 'clear') return this.clearLimit(message, res, <Command> rolesOrCommand);\r\n\t\telse return this.limitCommand(message, res, <Command> clearOrCommand, <string> rolesOrCommand);\r\n\t}\r\n\r\n\t/**\r\n\t * Clear all roles limiting the given command\r\n\t */\r\n\tpublic async clearLimit(message: Message, res: ResourceLoader, command: Command): Promise<any>\r\n\t{\r\n\t\tconst storage: GuildStorage = message.guild.storage;\r\n\t\tlet limitedCommands: { [name: string]: string[] } = await storage.settings.get('limitedCommands') || {};\r\n\t\tdelete limitedCommands[command.name];\r\n\t\tstorage.settings.set('limitedCommands', limitedCommands);\r\n\r\n\t\treturn this.respond(message,\r\n\t\t\tres(s.CMD_LIMIT_CLEAR_SUCCESS, { commandName: command.name }));\r\n\t}\r\n\r\n\t/**\r\n\t * Add the given roles to the limiter for the given command\r\n\t */\r\n\tpublic async limitCommand(message: Message, res: ResourceLoader, command: Command, roles: string): Promise<any>\r\n\t{\r\n\t\tif (command.group === 'base') return this.respond(message, res(s.CMD_LIMIT_ERR_INVALID_GROUP));\r\n\r\n\t\tconst roleResolver: Resolver = this.client.resolvers.get('Role');\r\n\t\tconst roleStrings: string[] = roles.split(/ *, */).filter(r => r !== '' && r !== ',');\r\n\r\n\t\tconst foundRoles: Role[] = [];\r\n\t\tconst invalidRoles: string[] = [];\r\n\r\n\t\tfor (const roleString of roleStrings)\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\tconst role: Role = await roleResolver.resolve(message, this, 'role', roleString);\r\n\t\t\t\tfoundRoles.push(role);\r\n\t\t\t}\r\n\t\t\tcatch { invalidRoles.push(roleString); }\r\n\r\n\t\tif (invalidRoles.length > 0) message.channel.send(res(s.CMD_LIMIT_ERR_INVALID_ROLE,\r\n\t\t\t{ invalidRoles: invalidRoles.map(r => `\\`${r}\\``).join(', ') }));\r\n\r\n\t\tif (foundRoles.length === 0) return this.respond(message, res(s.CMD_LIMIT_ERR_NO_ROLES));\r\n\r\n\t\tconst storage: GuildStorage = message.guild.storage;\r\n\t\tconst limitedCommands: { [name: string]: string[] } = await storage.settings.get('limitedCommands') || {};\r\n\t\tconst newLimit: Set<string> = new Set(limitedCommands[command.name] || []);\r\n\r\n\t\tfor (const role of foundRoles) newLimit.add(role.id);\r\n\t\tlimitedCommands[command.name] = Array.from(newLimit);\r\n\r\n\t\treturn this.respond(message, res(s.CMD_LIMIT_SUCCESS,\r\n\t\t\t{ roles: foundRoles.map(r => `\\`${r.name}\\``).join(', '), commandName: command.name }));\r\n\t}\r\n}\r\n"],"sourceRoot":"../../../../src"}